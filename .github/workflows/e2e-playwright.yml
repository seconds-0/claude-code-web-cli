name: E2E Tests (Playwright)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to test against"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  playwright-e2e:
    name: Playwright E2E (${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm --filter e2e-tests exec playwright install chromium

      - name: Determine environment URLs
        id: urls
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
          else
            ENV="staging"
          fi

          if [[ "$ENV" == "production" ]]; then
            echo "api_url=https://api.untethered.computer" >> $GITHUB_OUTPUT
            echo "web_url=https://www.untethered.computer" >> $GITHUB_OUTPUT
          else
            echo "api_url=https://api-staging.untethered.computer" >> $GITHUB_OUTPUT
            echo "web_url=https://staging.untethered.computer" >> $GITHUB_OUTPUT
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Run Playwright tests (shard ${{ matrix.shard }}/4)
        env:
          STAGING_API_URL: ${{ steps.urls.outputs.api_url }}
          STAGING_WEB_URL: ${{ steps.urls.outputs.web_url }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          E2E_CLERK_USER_USERNAME: ${{ secrets.E2E_CLERK_USER_USERNAME }}
          E2E_CLERK_USER_PASSWORD: ${{ secrets.E2E_CLERK_USER_PASSWORD }}
        run: pnpm --filter e2e-tests test --shard=${{ matrix.shard }}/4

      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: packages/e2e-tests/blob-report/
          retention-days: 1

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.shard }}
          path: packages/e2e-tests/test-results/
          retention-days: 7

  merge-reports:
    name: Merge Reports
    needs: playwright-e2e
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          pattern: blob-report-*
          merge-multiple: true
          path: all-blob-reports

      - name: Merge reports
        run: pnpm --filter e2e-tests exec playwright merge-reports --reporter html ./all-blob-reports

      - name: Upload merged HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: packages/e2e-tests/playwright-report/
          retention-days: 14
